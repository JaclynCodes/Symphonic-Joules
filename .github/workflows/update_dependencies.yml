name: Update Dependencies

on:
  schedule:
    # Run at 9:00 AM UTC every Monday
    - cron: 0 9 * * 1
  # Allow manual runs
  workflow_dispatch:
    inputs:
      package:
        description: >
          Specific package to update (e.g., numpy, librosa).
          Leave empty to check all packages.
        required: false
      version:
        description: >
          Target version for the package. Leave empty to use latest.
        required: false

env:
  PYTHON_VERSION: 3.11
  PIP_VERSION: 24.0

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    if: github.repository_owner == 'JaclynCodes'
    permissions:
      contents: write  # Needed to push changes
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Use default token for now, can be updated to use PAT if needed
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set Git author
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Upgrade pip
        run: |
          python -m pip install --upgrade pip==${{ env.PIP_VERSION }}

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Check for updates
        id: check_updates
        run: |
          # Install pip-tools for dependency management
          pip install pip-tools

          # Check for outdated packages
          echo "Checking for outdated packages..."
          pip list --outdated > outdated.txt
          cat outdated.txt

          if [ -s outdated.txt ]; then
            echo "updates_available=true" >> $GITHUB_OUTPUT
          else
            echo "updates_available=false" >> $GITHUB_OUTPUT
          fi

      - name: Update dependencies
        if: steps.check_updates.outputs.updates_available == 'true'
        run: |
          # Create a new branch for the update
          BRANCH_NAME="automated/update-dependencies-$(date +%Y%m%d)"
          git checkout -b "$BRANCH_NAME"

          # If specific package and version provided, update that
          if [ -n "${{ inputs.package }}" ]; then
            if [ -n "${{ inputs.version }}" ]; then
              echo "Updating ${{ inputs.package }} to version \
          ${{ inputs.version }}"
              # Use word boundaries to match exact package name
              sed -i "s/^${{ inputs.package }}[>=<].*/${{ inputs.package }}==\
          ${{ inputs.version }}/" requirements.txt
            else
              echo "Updating ${{ inputs.package }} to latest \
          compatible version"
              # Get latest version compatible with constraints
              LATEST=$(pip index versions "${{ inputs.package }}" | \
          grep "Available versions:" | head -1 | cut -d: -f2 | \
          tr ',' '\n' | head -1 | xargs)
              if [ -z "$LATEST" ]; then
                echo "Error: Could not determine latest version for \
          ${{ inputs.package }}"
                exit 1
              fi
              # Use word boundaries to match exact package name
              sed -i "s/^${{ inputs.package }}[>=<].*/${{ inputs.package }}>=\
          $LATEST/" requirements.txt
            fi
          else
            echo "No specific package provided for update."
            echo "Please run manually with package name to update."
            echo "Bulk updates require manual review and are not \
          automated."
            exit 0
          fi

          # Commit changes if there are any
          if git diff --quiet requirements.txt; then
            echo "No changes to commit"
            exit 0
          else
            git add requirements.txt
            COMMIT_MSG="Update ${{ inputs.package }} dependency"
            git commit -m "$COMMIT_MSG"
            git push origin "$BRANCH_NAME"

            # Create PR using GitHub CLI would go here if available
            echo "Branch $BRANCH_NAME created with updates"
          fi
